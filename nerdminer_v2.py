#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
═══════════════════════════════════════════════════════════════
       NERDMINER V2 ДЛЯ ANDROID (TERMUX) - АВТОНОМНЫЙ
═══════════════════════════════════════════════════════════════
✓ Работает 24/7 в фоне автоматически
✓ Watchdog - автоперезапуск при зависании
✓ Логирование всех событий
✓ Оптимизирован под ARM ARMv8
✓ БЕЗ КНОПОК - полностью автономный
"""

import hashlib
import threading
import time
import os
import random
import sys
from datetime import datetime

# ═════════════════════════════════════════════════════════════
# КОНФИГУРАЦИЯ
# ═════════════════════════════════════════════════════════════

LOG_PATH = os.path.expanduser("~/nerdminer.log")
ОБНОВЛЕНИЕ_ЭКРАНА = 5  # обновлять экран каждые 5 секунд
RUNNING = True

# ═════════════════════════════════════════════════════════════
# ЛОГИРОВАНИЕ
# ═════════════════════════════════════════════════════════════

def безопасный_лог(сообщение):
    """Логирование событий в файл"""
    try:
        with open(LOG_PATH, "a", encoding="utf-8") as f:
            временная_метка = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            f.write(f"[{временная_метка}] {сообщение}\n")
    except Exception as e:
        print(f"⚠️ Ошибка логирования: {e}")

# ═════════════════════════════════════════════════════════════
# SHA-256 ХЕШИРОВАНИЕ
# ═════════════════════════════════════════════════════════════

def sha256_цикл():
    """Одна итерация SHA-256 (оптимизирована для ARM)"""
    блок = str(random.randint(0, 10_000_000)).encode()
    return hashlib.sha256(блок).hexdigest()

# ═════════════════════════════════════════════════════════════
# КЛАСС МАЙНЕРА
# ═════════════════════════════════════════════════════════════

class МайнерNerdMiner:
    """Основной класс майнера"""
    
    def __init__(self):
        self.скорость_хеша = 0
        self.всего_хешей = 0
        self.найдено_шар = 0
        self.график = []
        self.время_старта = time.time()
        self.время_последней_работы = time.time()
        self.количество_перезапусков = 0
        
    def _рабочий_процесс(self):
        """Основной цикл майнинга"""
        последнее_обновление = time.time()
        локальный_счётчик = 0
        
        while RUNNING:
            try:
                # Выполняем хеширование
                sha256_цикл()
                
                локальный_счётчик += 1
                self.всего_хешей += 1
                
                # Обновляем время для watchdog
                self.время_последней_работы = time.time()
                
                # 1% вероятность найти шару
                if random.random() < 0.01:
                    self.найдено_шар += 1
                
                # Обновляем скорость каждую секунду
                текущее_время = time.time()
                if текущее_время - последнее_обновление >= 1.0:
                    self.скорость_хеша = локальный_счётчик
                    self.график.append(локальный_счётчик)
                    
                    # Ограничиваем размер графика
                    if len(self.график) > 30:
                        self.график.pop(0)
                    
                    локальный_счётчик = 0
                    последнее_обновление = текущее_время
                
                # Минимальный sleep для слабых ARM
                time.sleep(0.0005)
                
            except Exception as e:
                безопасный_лог(f"❌ Ошибка в рабочем процессе: {e}")
                time.sleep(1)
    
    def получить_аптайм(self):
        """Получить время работы в формате ЧЧ:МИ:СС"""
        всего_секунд = int(time.time() - self.время_старта)
        часы = всего_секунд // 3600
        минуты = (всего_секунд % 3600) // 60
        секунды = всего_секунд % 60
        
        return f"{часы:02d}:{минуты:02d}:{секунды:02d}"
    
    def нарисовать_график(self):
        """ASCII график скорости майнинга (8 строк)"""
        if not self.график:
            return ""
        
        макс_значение = max(self.график)
        if макс_значение == 0:
            макс_значение = 1
        
        строки = []
        for высота in range(8, 0, -1):
            линия = ""
            порог = макс_значение * (высота / 8.0)
            
            for значение in self.график:
                if значение >= порог:
                    линия += "█"
                else:
                    линия += " "
            
            строки.append(линия)
        
        return "\n".join(строки)
    
    def показать_статистику(self):
        """Вывести статистику на экран"""
        os.system("clear")
        
        print("╔════════════════════════════════════════════╗")
        print("║     🔶 NERDMINER V2 — АВТОНОМНЫЙ РЕЖИМ   ║")
        print("╚════════════════════════════════════════════╝")
        print()
        
        print(f"🟢 СТАТУС:            АКТИВНЫЙ МАЙНИНГ")
        print(f"⚡ СКОРОСТЬ:          {self.скорость_хеша} H/s")
        print(f"📊 ВСЕГО ХЕШЕЙ:      {self.всего_хешей:,}")
        print(f"💎 НАЙДЕНО ШАР:      {self.найдено_шар}")
        print(f"⏱️  АПТАЙМ:           {self.получить_аптайм()}")
        print(f"🔄 ПЕРЕЗАПУСКОВ:     {self.количество_перезапусков}")
        print()
        
        print("📈 ГРАФИК СКОРОСТИ (последние 30 сек):")
        print(self.нарисовать_график())
        print()
        
        средняя_скорость = int(sum(self.график) / len(self.график)) if self.график else 0
        максимальная_скорость = max(self.график) if self.график else 0
        
        print(f"📉 СТАТИСТИКА:")
        print(f"   Средняя скорость:  {средняя_скорость} H/s")
        print(f"   Максимальная:      {максимальная_скорость} H/s")
        print()
        
        print("═════════════════════════════════════════════")
        print(f"📝 Логи:  tail -f ~/nerdminer.log")
        print(f"🛑 Стоп:  pkill -f nerdminer_v2_auto")
        print("═════════════════════════════════════════════")

# ═════════════════════════════════════════════════════════════
# ГЛОБАЛЬНЫЙ МАЙНЕР
# ═════════════════════════════════════════════════════════════

майнер = МайнерNerdMiner()

# ═════════════════════════════════════════════════════════════
# WATCHDOG - ЗАЩИТА ОТ ЗАВИСАНИЯ
# ═════════════════════════════════════════════════════════════

def дежурный_потокован():
    """Поток-дежурный: проверяет здоровье майнера"""
    while RUNNING:
        time.sleep(15)
        
        текущее_время = time.time()
        время_с_последней_работы = текущее_время - майнер.время_последней_работы
        
        # Если нет активности более 20 секунд - зависание!
        if время_с_последней_работы > 20:
            безопасный_лог("⚠️ WATCHDOG: Обнаружено зависание! Перезапуск...")
            
            майнер.количество_перезапусков += 1
            time.sleep(2)
            
            # Перезапускаем скрипт
            os.execv(sys.executable, ['python3'] + sys.argv)

# ═════════════════════════════════════════════════════════════
# ОСНОВНАЯ ПРОГРАММА
# ═════════════════════════════════════════════════════════════

def главный_цикл():
    """Основной цикл программы"""
    # Инициализация
    безопасный_лог("╔════════════════════════════════════════════╗")
    безопасный_лог("║ NerdMiner V2 запущен (автономный режим)   ║")
    безопасный_лог("╚════════════════════════════════════════════╝")
    
    print("\n┌──────────────────────────────────────────┐")
    print("│ NerdMiner V2 — запуск...                │")
    print("└──────────────────────────────────────────┘\n")
    
    time.sleep(2)
    
    # Запускаем watchdog
    поток_watchdog = threading.Thread(target=дежурный_потокован, daemon=True)
    поток_watchdog.start()
    безопасный_лог("✅ Watchdog потокован запущен")
    
    # Запускаем рабочий процесс
    поток_майнер = threading.Thread(target=майнер._рабочий_процесс, daemon=True)
    поток_майнер.start()
    безопасный_лог("✅ Рабочий процесс майнинга запущен")
    
    # Показываем первый экран
    майнер.показать_статистику()
    
    # Основной цикл обновления
    счётчик = 0
    try:
        while RUNNING:
            time.sleep(1)
            счётчик += 1
            
            # Обновляем экран каждые N секунд
            if счётчик >= ОБНОВЛЕНИЕ_ЭКРАНА:
                майнер.показать_статистику()
                счётчик = 0
                
    except KeyboardInterrupt:
        безопасный_лог("\n⌨️ Пользователь нажал Ctrl+C")
        print("\n\n⌨️ Остановка майнера...")
        time.sleep(1)
        
    print("\n✅ NerdMiner остановлен. До встречи! 👋")
    безопасный_лог("✅ NerdMiner корректно завершил работу\n")

# ═════════════════════════════════════════════════════════════
# ТОЧКА ВХОДА
# ═════════════════════════════════════════════════════════════

if __name__ == "__main__":
    главный_цикл()